#include "model.h"

Model::Model(QObject *parent) : QObject(parent)
{
    textBank.push_back("\tSiege Warfare was a means to an end… this was a high risk, but high reward battle tactic, not for the faint of heart nor light of purse. Siege was incredibly expensive, grueling, and a time sink. Battles could last weeks, months, or even years. The longest battle in history was a total of 21 long years, during the Siege of Candia on the island of Crete.\n\tThe point of sieges was to capture an opponent’s stronghold, and therefore have more control over the enemy and their land. However, the result of close proximity and varying advantage was that they created opportunities for diplomacy and negotiations to help settle the battle and keep their finances from dropping too low.\n\tThe first known traces of siege warfare were found in the middle east back in 3500 BC with the Assyrians, and later the Babylonians with building sturdy and tall walls around their cities and then surrounding them with moats or rivers. Some of that design structure was implemented throughout history up until and after the middle ages. The Chinese in the 4th century BC, made the know well known weapon called the Trebuchet, in order to be able to attack from a farther distance and bring down those strong walls. Much later in the medieval ages, the English made the Siege Tower (also known as belfry) in order to get very close to the city walls and get in over the side for a quicker take down. The French were the first in the descent of sieges to popularize the use of cannons and gunpowder, the earliest medieval cannon, being called the pot-de-fer and being heavily used by the French in the Hundred Year’s War.");
    textBank.push_back("\tThe longest siege in medieval history was the siege of Kenilworth Castle that began in Warwickshire England during June of 1266 as part of England’s Second Barons’ War (1). In an attempt to win back his father’s castle from his brother-in-law and rebel leader Simon de Montfort, Henry III surrounded the castle walls and attacked with trebuchets and siege towers. Despite Henry’s formidable army of royal soldiers and massive siege weapons, the castle was not taken until December of 1266 a whole six months after the siege began. The siege only ended due to Kenilworth Castle’s large stockpile of food running dangerously low, forcing the defenders to surrender (2).\nSiege weapons like the trebuchet date all the way back to China in 300 BC, but were not used in England until the siege of Dover Castle in 1216 (3). A trebuchet is a large siege weapon, similar to a catapult, used to hurl large stones into the walls of an opponent’s castle. After the Siege of Dover, English King Edward the first saw the potential for the siege weapon and ordered his chief engineer Master James of St George to construct the largest Trebuchet ever built. Named Warwolf the trebuchet could throw stones of  three hundred pounds at speeds of up to 120 mph and level a city wall in just one throw. Standing at 300 feet tall, the trebuchet needed to be carried by 30 wagons to be transported (4).");
    textBank.push_back("\tMost of France’s participation with siege warfare was during the Hundred Year’s War from 1337 - 1453, when the English were claiming French lands and mounting invasions, however the French was well versed in siege warfare way before that prolific war came about.\n\t Back in the 11th century CE, early castles in France were built with the “Motte and Bailey” castle design. This entailed placing a wooden tower on a mound (motte) of earth, with a walled courtyard (bailey) surrounding the motte, at the base. The whole structure was then surrounded by a ditch or moat. Alongside those castle structures, the French were also well known to make use of the cannons and gunpowder, specifically one of the earliest cannons called the “pot-de-fer”, in the Hundred Year’s War, even assisting in its rise to popularity because of its long distance range and heavy damage.\n\t When distance attacks weren’t in the cards, the French would use battering rams as well, which were cost effective and allowed them to gain access within the city walls fairly quickly.");
    textBank.push_back("\tGreek colonists expelled the Phoenecians and took control of the city of Syracuse in 734 B.C. Over the next two centuries Syracuse became the largest city in the Greek world, with an estimated population of half a million people in the 5th Century B.C.(5) Prosperity ensued for many years until the Romans Republic took aim to control the entire island of Sicily and attacked the Greeks in the well-known Siege of Syracuse in 213-212 B.C.\n\tFor many months the Romans brought their assault by sea with siege weapons such as the sambuca and a floating siege tower. Impressively, with small catapults called Onagers, and the aid of the legendary inventions of Archimedes, the Claw of Archimedes, used to lift Roman ships and drop them to their doom, and Heat Ray (by use of mirrors), used to redirect sunrays and burn roman ships, Syracuse was successfully defended for many months. Due to suffering many casualties,  the Romans withdrew and the siege bogged down to a stalemate. That was until the Syracusans became overconfident, and a small party of Romans were able to infiltrate the city using grappling hooks. Soonafter, reinforcements soon took control and the siege became a Roman victory. The most notable event of this siege is the death of Archimedes. Although Marcus Claudius Marcellus had ordered that the great mathematician and inventor Archimedes be not killed, this was not the case. In his house and in the midst of his studies, Archimedes was disturbed by a Roman soldier. Archimedes was insistent to continue his work and rebuked the soldier; the soldier did not take kindly to this and killed him on the spot. (6)");
    textBank.push_back("\tRoman siege engines were, for the most part, adapted from Hellenistic siege technology. Relatively small efforts were made to develop the technology; however, the Romans brought an unrelentingly aggressive style to siege warfare that brought them repeated success. Up to the first century BC, the Romans utilized siege weapons only as required and relied for the most part on ladders and small stationary towers to assault a fortified town.\n\tThey were, however, were slow to actually start using the siege engine designs or towers that the Hellenistic kingdoms had introduced and perfected. The siege of Utica by Scipio Africanus in 204 BCE was one of the first times they used siege towers. They made a lot of changes, making their own towers smaller and so they were easier to move around. The towers also became more useful weapons in themselves when the Romans added battering rams, a boarding bridge, and interior fighting platforms which could carry both the men and artillery pieces, like ballistas or cannons. Towers had wheels so that they could be constructed at a safe distance from the city and then moved closer when required.");
    textBank.push_back("\tDid you know that siege weapons were made to order? They were far too cumbersome to move from one place to another. In a siege situation the commander would assess the situation and the siege weapons design requirements to break a siege. Engineers would instruct soldiers as to the design and construction of siege weapons and siege engines. A few siege weapons that we did not cover were Mangonels and Ballistas, but they were both very prominent in the medieval eras, as were the other weapons we talked about.\nMangonels: These weapons were a type of trebuchet called a traction trebuchet and is derived from the Latin word manganon which means “an engine of war”. The Mangonel was a highly accurate siege engine requiring expert building and design skills. Mangonels were capable of firing projectiles up to 1,300 feet. The Mangonel had one arm which was made of timber. Missiles were launched from a bowl-shaped bucket at the end of the arm. The rope attached to the arm was the spring of the Mangonel. The ropes were made of twisted strands of human hair or animal sinew. The rope at the bottom end of the throwing arm was twisted, providing the force to propel the arm.. Wheels were added to the base of the Mangonel ensuring manoeuvrability.\nThe Mangonel was created to torment or injure the troops on the opposing side- in order to do this, the items used in the Mangonel ranged from ordinary items like rocks to weaken walls to rotting or diseased body/body parts in order to weaken the actual people on the other side of the siege with illnesses and sorrow.\nBallistas: Ballistas were similar to big crossbows and used the same kind of mechanisms and was also tension based using a rig. The word 'Ballista' is derived from the Greek word 'Ballistes' meaning to throw. Although the design and building of the Ballista was highly accurate its range was less than that of the massive Trebuchet. The missiles launched by the Ballista were much lighter than the heavy trebuchet stones and could not gain the high momentum of the heavier missiles.\nThe origin of the Ballista was thought to have been from Greece and then adapted and changed by the Romans all the way back in 400 BC. The Ballista then reached Europe during the Medieval era and was used extensively by the French. Ballista history notes that the weapon introduced to England in 1216 during the Siege of Dover - as were many other types of siege engine. Louis the Dauphin of France crossed the Channel with a large force and laid siege to Dover Castle making a violent and incessant attack on the castle walls. He used the Ballista against the walls and men of Dover Castle. The constable of Dover castle was Hugh de Burgh - he refused to surrender.");

    englandImages.push_back(imageInfo("English coat of arms","One of the more prominent versions of the current English coat of arms","../EduApp/coatOfArmsEngland.jpg"));
    englandImages.push_back(imageInfo("A trebuchet","This is what a traditional trebuchet from the Medieval Era looked like - It could launch projectiles up to 300 meters and it's ropes were typically made from sinew and human hair","../EduApp/trebuchet.png"));
    englandImages.push_back(imageInfo("Crest","A very old crest made out of metal found that has been restored","../EduApp/crestEngland.jpg"));
    englandImages.push_back(imageInfo("Traditional English Flag","This is a flag of the city of London and is different to the typical flag as it has a red sword in the canton","../EduApp/englishFlag.png"));

    franceImages.push_back(imageInfo("A Medeival Tapestry","This is an old woven tapestry made of the french coat of arms","../EduApp/frenchTapestry.jpg"));
    franceImages.push_back(imageInfo("The King's Crest"," The formal crest made for one of the many kings of France","../EduApp/kingOfFrance.jpg"));
    franceImages.push_back(imageInfo("Coat of Arms","The official French coat of arms, which came about in the Middle Ages","../EduApp/frenchCoat.png"));
    franceImages.push_back(imageInfo("Pot de Fer","This is a historic painting of the favored siege weapon of France","../EduApp/potdefer.jpg"));

    romeImages.push_back(imageInfo("Crest of the Holy Roman Empire","One of the earlier iterations of the crest of the Holy Roman Empire","../EduApp/holyRomanEmpireCrest.jpeg"));
    romeImages.push_back(imageInfo("Full Crest of the Holy Roman Empire","The full image of the Holy Roman Empire- this is the most commonly used and recognized forms","../EduApp/romeCrest2.JPG"));
    romeImages.push_back(imageInfo("Siege Tower","The infamous siege tower used liberally by the roman armies to infiltrate besieged cities","../EduApp/siegeTower.jpg"));

    greeceImages.push_back(imageInfo("Claw of Archimedes","This was one of Archimedes more successful siege inventions and was used to catch the bow of the ship to either rupture the ship's structure or even sink it.","../EduApp/archClaw.jpg"));
    greeceImages.push_back(imageInfo("Greek Coat of Arms","The official Greek coat of arms for the royal family of Greece ","../EduApp/greekCoat.png"));
    greeceImages.push_back(imageInfo("The Heat Ray","The heat ray or 'death ray' developed by Archimedes using the sun's heat or ray of light along with a gigantic mirror in order to try and ignite incoming ships. It did not prove to work very well.","../EduApp/heatRay.jpg"));

    userScore = 0;
    freemode = false;

    englandDone = false;
    franceDone = false;
    greeceDone = false;
    romeDone = false;
    freeDone = false;

}

void Model::addUserName(std::string newName)
{
    this->userName = newName;
}

void Model::updateInfoTextSlot(std::string location)
{
    std::vector<std::string> strings;
    std::string::size_type pos = 0;
    std::string::size_type prev = 0;

    if(location == "All")
    {
        while ((pos = textBank[0].find("\n", prev)) != std::string::npos)
        {
            strings.push_back(textBank[0].substr(prev, pos - prev));
            prev = pos + 1;
        }
        strings.push_back(textBank[0].substr(prev));

        if(strings[0].size() < 900)
        {
            emit updateInfoText(strings[0]);
        }
    }
    else if(location == "England")
    {
        while ((pos = textBank[1].find("\n", prev)) != std::string::npos)
        {
            strings.push_back(textBank[1].substr(prev, pos - prev));
            prev = pos + 1;
        }
        strings.push_back(textBank[1].substr(prev));

        if(strings[0].size() < 900)
        {
            emit updateInfoText(strings[0]);
        }
    }
    else if(location == "France")
    {
        while ((pos = textBank[2].find("\n", prev)) != std::string::npos)
        {
            strings.push_back(textBank[2].substr(prev, pos - prev));
            prev = pos + 1;
        }
        strings.push_back(textBank[2].substr(prev));

        if(strings[0].size() < 1600){
            emit updateInfoText(strings[0]);
        }
    }
    else if(location == "Greece")
    {
        while ((pos = textBank[3].find("\n", prev)) != std::string::npos)
        {
            strings.push_back(textBank[3].substr(prev, pos - prev));
            prev = pos + 1;
        }
        strings.push_back(textBank[3].substr(prev));

        if(strings[0].size() < 900)
        {
            emit updateInfoText(strings[0]);
        }
    }
    else if(location == "Rome")
    {
        while ((pos = textBank[4].find("\n", prev)) != std::string::npos)
        {
            strings.push_back(textBank[4].substr(prev, pos - prev));
            prev = pos + 1;
        }
        strings.push_back(textBank[4].substr(prev));

        if(strings[0].size() < 900)
        {
            emit updateInfoText(strings[0]);
        }
    }
    else if(location == "Free")
    {
        while ((pos = textBank[5].find("\n", prev)) != std::string::npos)
        {
            strings.push_back(textBank[5].substr(prev, pos - prev));
            prev = pos + 1;
        }
        strings.push_back(textBank[5].substr(prev));

        if(strings[0].size() < 900)
        {
            emit updateInfoText(strings[0]);
        }
    }
    infoText = strings;
    infoIndex = 0;
}


void Model::getTriviaQuestionSlot(std::string location){
    if(location == "All")
    {
        freemode = true;
        unsigned randomIndex = std::abs(std::rand()) % allBank.GetSize();
        currentQuestion = allBank.GetQuestion(randomIndex);
        emit updateTriviaText(currentQuestion);
        currentLoctation = "All";
        questionIndex = randomIndex;
    }
    else if(location == "England")
    {
        freemode = false;
        unsigned randomIndex = std::rand() % englandBank.GetSize();
        currentQuestion = englandBank.GetQuestion(randomIndex);
        emit updateTriviaText(currentQuestion);
        currentLoctation = "England";
        questionIndex = randomIndex;
    }
    else if(location == "France")
    {
        freemode = false;
        unsigned randomIndex = std::rand() % franceBank.GetSize();
        currentQuestion = franceBank.GetQuestion(randomIndex);
        emit updateTriviaText(currentQuestion);
        currentLoctation = "France";
        questionIndex = randomIndex;
    }
    else if(location == "Greece")
    {
        freemode = false;
        unsigned randomIndex = std::rand() % greeceBank.GetSize();
        currentQuestion = greeceBank.GetQuestion(randomIndex);
        emit updateTriviaText(currentQuestion);
        currentLoctation = "Greece";
        questionIndex = randomIndex;
    }
    else if(location == "Rome")
    {
        freemode = false;
        unsigned randomIndex = std::rand() % romeBank.GetSize();
        currentQuestion = romeBank.GetQuestion(randomIndex);
        emit updateTriviaText(currentQuestion);
        currentLoctation = "Rome";
        questionIndex = randomIndex;
    }
    else
    {
        TriviaQuestion newQ = TriviaQuestion();
        currentQuestion = newQ;
        emit updateTriviaText(currentQuestion);
    }
}

void Model::checkGuessSlot(std::string guess)
{
    if(guess == currentQuestion.getCorrect()){
        emit checkAnswerSignal(true);
        userScore = userScore + 10;
    }
    else
    {
        emit checkAnswerSignal(false);
        userScore = userScore - 5;
    }
    emit updateViewScore(userScore);
}

void Model::nextInfoSlot()
{
    infoIndex += 1;
    if(infoIndex == infoText.size() - 1)
    {
        emit endOfInfoText();
    }
    emit updateInfoText(infoText[infoIndex]);
}

void Model::previousInfoSlot()
{
    infoIndex -= 1;
    if(infoIndex == 0)
    {
        emit startOfInfoText();
    }
    emit updateInfoText(infoText[infoIndex]);
}

void Model::removeQuestionSlot()
{
    if(currentLoctation == "All")
    {
        allBank.RemoveQuestion(questionIndex);
        if(allBank.GetSize() == 0)
        {
            emit doneWithLocation("All");
            getTriviaQuestionSlot("temp");
        }
        else
        {
            getTriviaQuestionSlot("All");
        }
    }
    else if(currentLoctation == "England")
    {
        englandBank.RemoveQuestion(questionIndex);
        if(englandBank.GetSize() == 0)
        {
            emit doneWithLocation("England");
            getTriviaQuestionSlot("temp");
        }
        else
        {
            getTriviaQuestionSlot("England");
        }
    }
    else if(currentLoctation == "France")
    {
        franceBank.RemoveQuestion(questionIndex);
        if(franceBank.GetSize() == 0)
        {
            emit doneWithLocation("France");
            getTriviaQuestionSlot("temp");
        }
        else
        {
            getTriviaQuestionSlot("France");
        }
    }
    else if(currentLoctation == "Greece")
    {
        greeceBank.RemoveQuestion(questionIndex);
        if(greeceBank.GetSize() == 0){
            emit doneWithLocation("Greece");
            getTriviaQuestionSlot("temp");
        }else{
            getTriviaQuestionSlot("Greece");
        }
    }
    else if(currentLoctation == "Rome")
    {
        romeBank.RemoveQuestion(questionIndex);
        if(romeBank.GetSize() == 0)
        {
            emit doneWithLocation("Rome");
            getTriviaQuestionSlot("temp");
        }
        else
        {
            getTriviaQuestionSlot("Rome");
        }
    }
}

void Model::resetNextPrevBtnSlot()
{
    infoIndex = 0;
    emit updateInfoText(infoText[infoIndex]);
}

void Model::getImageSlot(std::string location,int index){
    if(location == "England")
    {
        if(index >= (int)englandImages.size())
        {
            index = 0;
        }
        else if(index == -1)
        {
            index = (int)englandImages.size() -1;
        }
        emit updateImage(englandImages[index],index);
    }
    else if (location == "France")
    {
        if(index >= (int)franceImages.size())
        {
            index = 0;
        }
        else if(index == -1)
        {
            index = (int)franceImages.size() -1;
        }
       emit updateImage(franceImages[index],index);
    }
    else if (location == "Rome")
    {
        if(index >= (int)romeImages.size())
        {
            index = 0;
        }
        else if(index == -1)
        {
            index = (int)romeImages.size() -1;
        }
        emit updateImage(romeImages[index],index);
    }
    else if (location == "Greece"){
        if(index >= (int)greeceImages.size())
        {
            index = 0;
        }
        else if(index == -1)
        {
            index = (int)greeceImages.size() -1;
        }
        emit updateImage(greeceImages[index],index);
    }
}


void Model::startAudioSlot(std::string location)
{

    narrative.setVolume(100.f);

    if(location == "England")
    {
        narrative.openFromFile("../EduApp/englandText.wav");
        narrative.play();
    }
    else if (location == "France")
    {
        narrative.openFromFile("../EduApp/franceText.wav");
        narrative.play();
    }
    else if (location == "Rome")
    {
        narrative.openFromFile("../EduApp/romeText.wav");
        narrative.play();
    }
    else if (location == "Greece")
    {
        narrative.openFromFile("../EduApp/greeceText.wav");
        narrative.play();
    }
    else if  (location == "Free")
    {
        narrative.openFromFile("../EduApp/freePlay.wav");
        narrative.play();
    }
    else if  (location == "Home")
    {
        narrative.openFromFile("../EduApp/introText.wav");
        narrative.play();
    }
}

void Model::stopAudioSlot()
{
    narrative.stop();
}

void Model::pauseAudioSlot()
{
    narrative.pause();
}

void Model::resumeAudioSlot()
{
    narrative.play();
}


void Model::playAnimationSlot(std::string location)
{
    if(location == "England")
    {
        emit playEnglandAnim();
    }
    else if (location == "France")
    {
        emit playFranceAnim();
    }
    else if (location == "Rome")
    {
        emit playRomeAnim();
    }
    else if (location == "Greece")
    {
        emit playGreeceAnim();
    }

}


void Model::finishedLocationSlot(std::string location)
{
    if(location == "England")
    {
        englandDone = true;
    }
    else if (location == "France")
    {
        franceDone = true;
    }
    else if (location == "Rome")
    {
        romeDone = true;
    }
    else if (location == "Greece")
    {
        greeceDone = true;
    }
    else if(location == "Free")
    {
        freeDone = true;
    }
    if(englandDone && franceDone && romeDone && greeceDone && freeDone)
    {
        emit endGame();
    }
}


